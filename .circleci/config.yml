version: 2.1

orbs:
  docker: circleci/docker@2.4.0
  snyk: snyk/snyk@2.0.1
  maven: circleci/maven@1.4.1

executors:
  default-executor:
    docker:
      - image: cimg/openjdk:17.0.8

jobs:
  build: # Define the 'build' job
    executor: default-executor
    steps:
      - checkout # Check out your code from version control

      # Add a step to update the permissions of the mvnw file
      - run:
          name: Update mvnw permissions
          command: chmod +x ./mvnw

      - run:
          name: Build Spring Boot App
          # Compile and package your Spring Boot app with Maven
          command: |
            ./mvnw clean package -DskipTests
            mv target/springmart-backend-0.0.1-SNAPSHOT.jar app.jar

  test:
    executor: default-executor
    steps:
      - checkout
      - run:
          name: Run Test
          command: |
            mvn test

  synk_scan:
    executor: default-executor
    environment:
      IMAGE_NAME: justenmx/springmart-backend

    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Update mvnw permissions
          command: chmod +x ./mvnw

      - run:
          name: Build Springmart Backend
          command: ./mvnw clean package -DskipTests

      - run:
          name: Copy artifact to context
          # The mv target/pdt_sales-0.0.1-SNAPSHOT.jar app.jar command moves the built artifact (the JAR file) from the target directory to the context directory. This is necessary because the Docker build command will only copy files from the context directory into the image.
          command: mv target/springmart-backend-0.0.1-SNAPSHOT.jar app.jar

      - run:
          name: Build Docker image
          command: docker build -t $IMAGE_NAME .

      - snyk/scan:
          docker-image-name: $IMAGE_NAME
          severity-threshold: low

workflows:
  ci_flow:
    jobs:
      - build
      - test:
          requires:
            - build
      - synk_scan:
          requires:
            - build
